---
date: 2024/05/21
cate: 路径
hidden: true
---

# Seati Lab 后端注解

## 综述

这一项目最初想法的产生，源于 [SomeBottle](https://bottle.moe/) 在前些年提到的一种使用阿里云提供的*抢占式实例*来实现以较低成本运营 Minecraft 服务器的方案。Seati（2023 年以前叫做 Seatide）在 2022 年曾经实现过一段时间这样的模式，并基本验证了这种方案的可行性，同时也成功节省了许多成本。在 Seatide 改为 Seati 后，我希望能够搭建一个可以与游戏紧密联系的「社区」类平台。在搭建这一平台之前，首先需要保证服务器的正常运行，遂决定采用一些较新的技术栈重写这一平台。

整个平台按照简单的前后端分离模式编写，首先开发的是后端的内容，之后开发的是前端。相比于上一次，技术栈发生了比较大的改变。

| |2024 年重写|2022 年实现|
|:-:|:-:|:-:|
|Repo|[seatitanium/lab-backend](https://github.com/seatitanium/lab-backend)|[seatidemc/backend](https://github.com/seatidemc/backend)|
|前端|Nuxt 3<br/>Vue 3|Vue 2|
|后端|gin 1.9.1<br/>Go 1.21.6|Flask 2<br/>Python 3|

本文章将聚焦于后端部分，提供一些我个人的角度的一些构想和解释，作为参考文档的一部分。

## 1. 抢占式实例

### 简介

采用阿里云抢占式实例进行服务器的运转，最主要的原因是这类实例提供了（相比于其它可能方案来说的）成本最低的运营方案。阿里云平台上的实例有三种付费方式：

- 包年包月
- 按量计费
- 抢占式实例

抢占式实例可以理解为一种特殊的按量计费。普通的按量计费模式，是对用量进行一个明确的定价，再按照具体的消费情况对其进行计算、扣费，适合短期使用，与包年包月相比，相当于提供了一种允许使用低于一个月的付费方案。这种模式在长期使用的情况下有可能造成成本高于包年包月的状况。

抢占式实例的定价并不完全稳定，而是按照市场供需关系进行调整。每个用户进行一定的出价，当出价满足定价、库存满足时，便可以继续保有实例。根据测试[^1]，这种保有权检测的周期大致为一个小时。相比于按量计费，抢占式实例并不能提供一个绝对稳定的运行环境，实例的保有权受外界因素影响。

不过，阿里云提供了一样自动出价的选项。根据测试[^1]，当该选项被选中时，抢占式实例很难被释放——不过扣费的价格会出现一定的波动，这是因为自动出价策略总是按照高于或者等于市场定价出价，从而达到持久保有实例的效果。

但是持久保有实例并非我们最终所需要的。实际上，我们所需要的只是服务器的「按需运行」，即当服务器中没有玩家的时候，考虑一定的延迟，之后备份数据、释放服务器，从而达到更进一步的对成本的节省。这一点便是整个抢占式实例的核心。

因此，根据上面这些理论与实践的结合，抢占式实例完全不失为一种巧妙、便捷而又节省成本的运行 Minecraft 服务器的模式。不过很明显的一点是，如果想要让这样一种模式按照某种适合的逻辑运行起来，额外的程序加持是有必要的，这也是编写 Lab 这一平台最主要的一个原因。

上面提到的「按需运行」引出了一样抢占式实例的局限性，大致可以总结为「非绝对永久实例所造成的个体标识问题」。例如，[MCMOD](https://www.mcmod.cn/) 这一平台的「找服玩」板块支持服主提交自己的服务器相关信息以求曝光，其中需要填写的一项是服务器的 IP 地址，用于在该网站上显示服务器当前的状态。这时就出现了 IP 不固定所造成的无法提交的问题。此外还有更多需要长期获取「标识符」的服务器都不能正常使用。

:::tip
其实无论是从外部网站，还是从自身开发的角度上来讲，固定的 IP 地址的确是更好的选择。「别人的平台」与「自己的平台」的区别在于，对「自己的平台」而言，可以选择主动调用动态的 IP 信息，而外部网站会考虑到开发、维护成本而只支持静态的 IP 地址。

考虑到上面这一点，Seati 更加倾向于自身平台的开发，以求更多方面的可用性。
:::

[^1]: 这里的「测试」是指 2022 年 Seatide 采用这种模式开服务器的几个月里，通过阿里云账单提供的费用数据总结而得出的结论。

### 核心逻辑

在抢占式实例上运行 Minecraft 服务器，最需要确保的是数据的持久性，这是一种对数据安全的保障。在这一点上发挥作用的仍然是阿里云的产品——阿里云 OSS。OSS（或者腾讯云的 COS 等类似概念）提供了一种通过内网，从实例向 bucket 中高速传输数据的方式，其价格也较为低廉，因此可以视为与抢占式实例所搭配的一样必需品。在这里，我们提出了两样需求

- 云端存储空间
- 高速内网传输

对运算存储空间的需求的原因，可以概括为下面两点

1. 客观上的存储空间大小问题，云端所提供的存储空间独立于本地系统（若不考虑本地系统，就是需要自行组织云端空间）之外，显然更加便捷
2. 内网的存在，这一点较为显然。

对高速内网传输的需求，是在考虑到数据大小以后，对数据安全的一种保障的需求。

在满足了存储方面的需求以后，整个服务器的运行逻辑可以概括为下面几点

- 创建实例时，从空白状态开始，使用脚本部署服务器的运行环境，并从 OSS 中获取到最近一次的备份档案。
- 当实例没有玩家超过一定时间时，自动备份档案并释放实例，从而大幅度减少成本。
- 定期自动备份档案，以避免抢占式实例的意外释放造成损失

考虑到实例有的时候并不存在，因此在这样的模式下，对于玩家来说会多出两道不同于传统持久服务器的步骤

- 玩家需要手动开启实例，或者以某种方式调用开启实例的 API
- 玩家需要一样可以动态获取当前 IP 的工具（模组），从而避免频繁手动获取和复制 IP

这样两点对玩家多出的要求，经过测试并不会影响太多玩家的积极性，但在网页上的一些 API 操作却对于一些技术力较低的玩家而言仍然棘手，甚至可以打消他们对服务器的兴趣。要解决这一点，初步的考虑是采用玩家更熟悉的方式，例如 QQ 群机器人（这也是 SomeBottle 采用过的方式）等来完成对相关 API 调用。

## 2. 后端实现

后端采用 gin 框架，倾向于使用 RESTful 的模式设计 API。